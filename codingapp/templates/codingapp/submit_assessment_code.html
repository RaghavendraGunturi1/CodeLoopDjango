{% extends 'codingapp/assessment_base.html' %}

{% block assessment_content %}
    <h3>{{ question.title }}</h3>
    <p>{{ question.description|linebreaksbr }}</p>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} mt-3">{{ message }}</div>
        {% endfor %}
    {% endif %}
    
    {% if task_id %}
    <div id="polling-status-message" class="alert alert-info mt-3" role="alert">
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        Submission received. Status: PENDING (Running tests in background...)
    </div>
    {% endif %}

    <form method="POST" id="assessment-submission-form">
        {% csrf_token %}
        <div class="mb-3">
            <label for="language">Language:</label>
            <select name="language" id="language" class="form-select" style="max-width: 200px;" {% if read_only %}disabled{% endif %}>
                {% for lang in supported_languages %}
                    <option value="{{ lang }}" {% if lang == selected_language %}selected{% endif %}>{{ lang|capfirst }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label for="code">Your Code:</label>
            <textarea id="code" name="code" style="display: none;">{{ code }}</textarea>
        </div>

        {% if not read_only %}
            <button type="submit" class="btn btn-primary">Submit Code</button>
        {% else %}
            <div class="alert alert-success mt-3">✅ This question is locked.</div>
        {% endif %}
    </form>
    
    {% if results %}
        <hr>
        <h5>Test Case Results</h5>
        {% endif %}

{% endblock %}

{% block assessment_extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const codeTextarea = document.getElementById("code");
    const langSelect = document.getElementById("language");
    const readOnlyMode = "{{ read_only|yesno:'true,false' }}" === "true";
    const languageModes = {
        python: "python", javascript: "javascript", java: "text/x-java",
        c: "text/x-csrc", cpp: "text/x-c++src"
    };

    const initialTaskId = "{{ task_id }}";
    const API_STATUS_URL = "{% url 'check_submission_status' task_id='DUMMY_TASK_ID' %}";
    const pollingMessageContainer = document.getElementById('polling-status-message');
    
    editor = CodeMirror.fromTextArea(codeTextarea, {
        lineNumbers: true,
        matchBrackets: true,
        autoCloseBrackets: true,
        theme: "dracula",
        mode: languageModes[langSelect.value] || "python",
        readOnly: readOnlyMode
    });

    const editorWrapper = editor.getWrapperElement();
    editorWrapper.addEventListener('cut', (e) => e.preventDefault());
    editorWrapper.addEventListener('copy', (e) => e.preventDefault());
    editorWrapper.addEventListener('paste', (e) => e.preventDefault());

    if (!readOnlyMode) {
        langSelect.addEventListener("change", () => editor.setOption("mode", languageModes[langSelect.value]));
    }

    const form = document.querySelector("#assessment-submission-form");
    const submitBtn = form.querySelector("button[type='submit']");
    
    form.addEventListener("submit", (e) => {
        e.preventDefault();
        editor.save();
        if (!editor.getValue().trim()) {
            alert("Code cannot be empty!");
            return;
        }
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...`;
        }
        setTimeout(() => { form.submit(); }, 100); 
    });

    // ⭐ FIX: Logic to handle button state during polling
    if (initialTaskId && initialTaskId !== 'None') {
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = `
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Processing...
            `;
        }

        const pollInterval = 2000;
        const url = API_STATUS_URL.replace('DUMMY_TASK_ID', initialTaskId);
        
        const intervalId = setInterval(function() {
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (pollingMessageContainer) {
                         pollingMessageContainer.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Submission processing... Status: ${data.status}`;
                    }
                    if (data.ready) {
                        clearInterval(intervalId);
                        window.location.reload(); 
                    }
                })
                .catch(error => {
                    console.error('Polling error:', error);
                    clearInterval(intervalId);
                    if (pollingMessageContainer) {
                         pollingMessageContainer.textContent = 'Error checking status.';
                    }
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Code';
                    }
                });
        }, pollInterval);
    }
});
</script>
<style>
    .CodeMirror {
        height: 400px;
        border: 1px solid #ddd;
    }
</style>
{% endblock %}