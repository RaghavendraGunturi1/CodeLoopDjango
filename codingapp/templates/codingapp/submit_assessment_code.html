{% extends 'codingapp/assessment_base.html' %}

{% block assessment_content %}
    <h3>{{ question.title }}</h3>
    <p>{{ question.description|linebreaksbr }}</p>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} mt-3">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <form method="POST">
        {% csrf_token %}
        <div class="mb-3">
            <label for="language">Language:</label>
            <select name="language" id="language" class="form-select" style="max-width: 200px;" {% if read_only %}disabled{% endif %}>
                {% for lang in supported_languages %}
                    <option value="{{ lang }}" {% if lang == selected_language %}selected{% endif %}>{{ lang|capfirst }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label for="code">Your Code:</label>
            <textarea id="code" name="code" style="display: none;">{{ code }}</textarea>
        </div>

        {% if not read_only %}
            <button type="submit" class="btn btn-primary">Submit Code</button>
        {% else %}
            <div class="alert alert-success mt-3">âœ… This question is locked because you have solved it or the time is up.</div>
        {% endif %}
    </form>
    {% if results %}
        <hr>
        <h5>Test Case Results</h5>
        <div class="list-group">
            {% for result in results %}
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">Input: <pre class="d-inline">{{ result.input }}</pre></h6>
                        <span class="badge {% if result.status == 'Accepted' %}bg-success{% else %}bg-danger{% endif %} rounded-pill">{{ result.status }}</span>
                    </div>
                    <p class="mb-1"><strong>Expected:</strong> <pre class="d-inline">{% for line in result.expected_output %}{{ line }}{% if not forloop.last %}\n{% endif %}{% endfor %}</pre></p>
                    <p class="mb-1"><strong>Your Output:</strong> <pre class="d-inline">{% for line in result.actual_output %}{{ line }}{% if not forloop.last %}\n{% endif %}{% endfor %}</pre></p>
                    {% if result.error_message %}<small class="text-danger">{{ result.error_message }}</small>{% endif %}
                </div>
            {% endfor %}
        </div>
    {% endif %}

{% endblock %}

{% block assessment_extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Make 'editor' a global variable so the base template can access it.
    var editor; 
    
    const codeTextarea = document.getElementById("code");
    const langSelect = document.getElementById("language");
    const readOnlyMode = "{{ read_only|yesno:'true,false' }}" === "true";
    const languageModes = {
        python: "python", javascript: "javascript", java: "text/x-java",
        c: "text/x-csrc", cpp: "text/x-c++src"
    };
    
    // Assign to the global 'editor' variable
    editor = CodeMirror.fromTextArea(codeTextarea, {
        lineNumbers: true,
        matchBrackets: true,
        autoCloseBrackets: true, // This enables auto-completion
        theme: "dracula",
        mode: languageModes[langSelect.value] || "python",
        readOnly: readOnlyMode
    });

    // --- THIS IS THE FIX FOR COPY/PASTE ---
    // Get the editor's wrapper element and attach event listeners directly
    const editorWrapper = editor.getWrapperElement();
    editorWrapper.addEventListener('cut', (e) => e.preventDefault());
    editorWrapper.addEventListener('copy', (e) => e.preventDefault());
    editorWrapper.addEventListener('paste', (e) => e.preventDefault());


    if (!readOnlyMode) {
        langSelect.addEventListener("change", () => editor.setOption("mode", languageModes[this.value]));
    }

    const form = document.querySelector("form");
    const submitBtn = form.querySelector("button[type='submit']");
    
    form.addEventListener("submit", (e) => {
        // --- THIS IS THE FIX ---
        // 1. Prevent the form from submitting immediately.
        e.preventDefault();

        editor.save();
        if (!editor.getValue().trim()) {
            alert("Code cannot be empty!");
            return; // Stop if there's no code
        }

        // 2. Show the loading state.
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = `
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Executing...
            `;
        }
        
        // 3. Give the browser a moment to repaint, then submit the form.
        setTimeout(() => {
            form.submit();
        }, 100); // 100ms delay is enough
    });
});
</script>
<style>
    .CodeMirror {
        height: 400px;
        border: 1px solid #ddd;
    }
</style>
{% endblock %}