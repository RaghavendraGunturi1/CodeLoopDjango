{% extends 'codingapp/assessment_base.html' %}

{% block assessment_content %}
    <h3>{{ question.title }}</h3>
    <p>{{ question.description|linebreaksbr }}</p>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} mt-3">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <!-- Status area for this submission (AJAX updated) -->
    <div id="submission-status" class="mt-3"></div>

    <form method="POST" id="assessment-submission-form">
        {% csrf_token %}
        <div class="mb-3">
            <label for="language">Language:</label>
            <select name="language" id="language" class="form-select" style="max-width: 200px;" {% if read_only %}disabled{% endif %}>
                {% for lang in supported_languages %}
                    <option value="{{ lang }}" {% if lang == selected_language %}selected{% endif %}>{{ lang|capfirst }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label for="code">Your Code:</label>
            <textarea id="code" name="code" style="display: none;">{{ code }}</textarea>
        </div>

        {% if not read_only %}
            <button type="submit" class="btn btn-primary" id="submit-btn">Submit Code</button>
        {% else %}
            <div class="alert alert-success mt-3">‚úÖ This question is locked.</div>
        {% endif %}
    </form>

    <hr>

    <h5>Test Case Results</h5>
    <div id="results-container">
        {% if results %}
            <div class="table-responsive">
                <table class="table table-bordered table-dark">
                    <thead>
                        <tr><th>Input</th><th>Expected Output</th><th>Your Output</th><th>Status</th></tr>
                    </thead>
                    <tbody>
                    {% for r in results %}
                        <tr>
                            <td><pre>{{ r.input }}</pre></td>
                            <td><pre>{{ r.expected_output|join:"\n" }}</pre></td>
                            <td><pre>{{ r.actual_output|join:"\n" }}</pre></td>
                            <td class="{% if r.status == 'Accepted' %}text-success{% else %}text-danger{% endif %}">
                                {{ r.status }}
                                {% if r.error_message %}
                                    <pre class="text-danger small">{{ r.error_message }}</pre>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-muted">No submission yet for this language.</p>
        {% endif %}
    </div>

    {{ user_submissions|json_script:"user-submissions-data" }}
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const codeTextarea = document.getElementById("code");
        const langSelect = document.getElementById("language");
        const readOnlyMode = "{{ read_only|yesno:'true,false' }}" === "true";
        const form = document.getElementById("assessment-submission-form");
        const submitBtn = document.getElementById("submit-btn");
        const statusArea = document.getElementById("submission-status");
        const resultsContainer = document.getElementById("results-container");

        const languageModes = {
            python: "python",
            javascript: "javascript",
            java: "text/x-java",
            c: "text/x-csrc",
            cpp: "text/x-c++src"
        };

        // --- Initialize CodeMirror ---
        const editor = CodeMirror.fromTextArea(codeTextarea, {
            lineNumbers: true,
            matchBrackets: true,
            autoCloseBrackets: true,
            theme: "dracula",
            mode: languageModes[langSelect.value] || "python",
            readOnly: readOnlyMode,
            cursorBlinkRate: readOnlyMode ? -1 : 530
        });

        // ‚úÖ Robust copy/paste/cut blocking
        setTimeout(() => {
            const inputField = editor.getInputField();
            ["cut", "copy", "paste"].forEach(event =>
                inputField.addEventListener(event, e => e.preventDefault())
            );
        }, 300);

        // --- Restore multi-language saved code ---
        let userSubmissions = {};
        const dataElem = document.getElementById("user-submissions-data");
        if (dataElem) {
            try {
                userSubmissions = JSON.parse(dataElem.textContent) || {};
            } catch (err) {
                console.error("Failed to parse user_submissions JSON", err);
            }
        }

        if (userSubmissions[langSelect.value]) {
            editor.setValue(userSubmissions[langSelect.value]);
        }

        // --- Handle language switching ---
        langSelect.addEventListener("change", function() {
            const newLang = langSelect.value;
            editor.setOption("mode", languageModes[newLang] || "python");
            if (userSubmissions[newLang]) {
                editor.setValue(userSubmissions[newLang]);
            } else {
                editor.setValue("");
            }
        });

        function setStatus(html) {
            statusArea.innerHTML = html || "";
        }

        function renderResultsTable(results) {
            if (!results || !results.length) {
                resultsContainer.innerHTML = '<p class="text-muted">No submission yet for this language.</p>';
                return;
            }

            let rowsHtml = "";
            results.forEach(r => {
                const statusClass = (r.status === "Accepted") ? "text-success" : "text-danger";
                const errorPart = r.error_message
                    ? `<pre class="text-danger small">${r.error_message}</pre>`
                    : "";
                const expectedOut = Array.isArray(r.expected_output) ? r.expected_output.join("\\n") : r.expected_output;
                const actualOut = Array.isArray(r.actual_output) ? r.actual_output.join("\\n") : r.actual_output;

                rowsHtml += `
                    <tr>
                        <td><pre>${r.input || ""}</pre></td>
                        <td><pre>${expectedOut || ""}</pre></td>
                        <td><pre>${actualOut || ""}</pre></td>
                        <td class="${statusClass}">
                            ${r.status || ""}
                            ${errorPart}
                        </td>
                    </tr>
                `;
            });

            resultsContainer.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-bordered table-dark">
                        <thead>
                            <tr><th>Input</th><th>Expected Output</th><th>Your Output</th><th>Status</th></tr>
                        </thead>
                        <tbody>${rowsHtml}</tbody>
                    </table>
                </div>
            `;
        }

        // --- Poll Celery for task result ---
        function pollTask(taskId, attempt = 0) {
            fetch(`?task_id=${encodeURIComponent(taskId)}`, {
                method: "GET",
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                },
                credentials: "same-origin"
            })
            .then(resp => resp.json())
            .then(data => {
                if (!data.ok) {
                    setStatus(`<div class="alert alert-danger mt-3">Error: ${data.error || "Unknown error"}</div>`);
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = "Submit Code";
                    }
                    return;
                }

                if (!data.completed) {
                    setStatus(`
                        <div class="alert alert-info mt-3" role="alert">
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            Processing submission... Status: ${data.state || "PENDING"}
                        </div>
                    `);
                    setTimeout(() => pollTask(taskId, attempt + 1), 2000);
                    return;
                }

                // Completed
                renderResultsTable(data.results);

                let alertHtml = "";
                if (data.final_status === "Accepted") {
                    // üîí Lock the editor & controls on full acceptance
                    try {
                        if (typeof editor !== "undefined") {
                            editor.setOption("readOnly", true);
                            editor.setOption("cursorBlinkRate", -1);
                            const wrapper = editor.getWrapperElement();
                            if (wrapper) {
                                wrapper.classList.add("CodeMirror-readonly");
                            }
                        }
                        if (submitBtn) {
                            submitBtn.disabled = true;
                            submitBtn.textContent = "Accepted ‚úî";
                        }
                        if (typeof langSelect !== "undefined" && langSelect) {
                            langSelect.disabled = true;
                        }
                    } catch (e) {
                        console.warn("Failed to lock editor after acceptance:", e);
                    }

                    alertHtml = `<div class="alert alert-success mt-3">
                        ‚úÖ Code Accepted! All test cases passed. (Plagiarism: ${data.plagiarism_percent ?? 0}% )
                        <br><small>This question is now locked.</small>
                    </div>`;
                } else if (data.error) {
                    alertHtml = `<div class="alert alert-danger mt-3">‚ùå Execution Error: ${data.error}</div>`;
                } else {
                    alertHtml = `<div class="alert alert-warning mt-3">‚ö†Ô∏è Some test cases failed. (Status: ${data.final_status || "Unknown"})</div>`;
                }
                setStatus(alertHtml);

                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Submit Code";
                }
            })
            .catch(err => {
                console.error("Error polling task:", err);
                setStatus(`<div class="alert alert-danger mt-3">Error while polling submission status. Check your connection.</div>`);
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Submit Code";
                }
            });
        }

        // --- AJAX submit handler ---
        if (form && !readOnlyMode && submitBtn) {
            form.addEventListener("submit", function(e) {
                e.preventDefault();

                // Sync CodeMirror -> textarea
                codeTextarea.value = editor.getValue();

                const formData = new FormData(form);

                submitBtn.disabled = true;
                submitBtn.textContent = "Submitting...";
                setStatus(`
                    <div class="alert alert-info mt-3" role="alert">
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        Sending submission to the server...
                    </div>
                `);

                fetch("", {
                    method: "POST",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest"
                    },
                    credentials: "same-origin",
                    body: formData
                })
                .then(resp => resp.json())
                .then(data => {
                    if (!data.ok) {
                        setStatus(`<div class="alert alert-danger mt-3">Error submitting code: ${data.error || "Unknown error"}</div>`);
                        submitBtn.disabled = false;
                        submitBtn.textContent = "Submit Code";
                        return;
                    }

                    setStatus(`
                        <div class="alert alert-info mt-3" role="alert">
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            Submission received. Running tests in background...
                        </div>
                    `);

                    if (data.task_id) {
                        pollTask(data.task_id);
                    } else {
                        setStatus(`<div class="alert alert-danger mt-3">Server did not return a task_id.</div>`);
                        submitBtn.disabled = false;
                        submitBtn.textContent = "Submit Code";
                    }
                })
                .catch(err => {
                    console.error("Submit error:", err);
                    setStatus(`<div class="alert alert-danger mt-3">Network error while submitting code.</div>`);
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Submit Code";
                });
            });
        }
    });
    </script>

    <style>
        .CodeMirror {
            height: 400px;
            border: 1px solid #ddd;
        }
        .CodeMirror.cm-s-dracula.CodeMirror-readonly {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
{% endblock %}
