{% extends 'codingapp/base.html' %}
{% load form_filters %}

{% block title %}{{ question.title }}{% endblock %}

{% block content %}
<div class="card p-4">
    <h2>{{ question.title }}</h2>
    <p>{{ question.description|linebreaksbr }}</p>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <h3>Submit Your Code:</h3>
    <form method="post" action="{% url 'question_detail' question.pk %}" id="code-submit-form">
        {% csrf_token %}
        <div class="mb-3">
            <label for="language-select" class="form-label"><strong>Select Language:</strong></label>
            <select id="language-select" name="language" class="form-control mb-2">
                {% for lang in 'python,c,cpp,java,javascript'|split:',' %}
                    <option value="{{ lang }}" {% if selected_language == lang %}selected{% endif %}>{{ lang|capfirst }}</option>
                {% endfor %}
            </select>
        </div>
        <textarea id="code-editor" name="code">{{ code|escape }}</textarea>
        <button type="submit" class="btn btn-primary mt-2">Submit</button>
    </form>

    <hr>
    
    <h4 class="mt-4">Try with Custom Input</h4>
    <div class="mb-3">
        <label for="custom-input" class="form-label">Enter Custom Input</label>
        <textarea id="custom-input" rows="4" class="form-control font-monospace" placeholder="Enter your input here..."></textarea>
    </div>
    <button id="run-custom-btn" class="btn btn-outline-secondary">Run Code</button>
    <pre id="custom-output" class="bg-light border p-3 mt-3" style="white-space: pre-wrap;"></pre>

    <h3 class="mt-4">Submission Results:</h3>

    <div id="results-container">
        {% if submission and submission.status == 'Pending' %}
            <div class="alert alert-info" id="pending-submission">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <strong>Your submission is being processed.</strong> The results will appear here automatically.
            </div>
        {% elif results %}
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="thead-dark">
                        <tr><th>Input</th><th>Expected Output</th><th>Actual Output</th><th>Status</th></tr>
                    </thead>
                    <tbody>
                        {% for result in results %}
                        <tr>
                            <td><pre>{{ result.input|default:"(No Input)" }}</pre></td>
                            <td><pre>{% for line in result.expected_output %}{{ line }}{% if not forloop.last %}\n{% endif %}{% endfor %}</pre></td>
                            <td><pre>{% for line in result.actual_output %}{{ line }}{% if not forloop.last %}\n{% endif %}{% endfor %}</pre></td>
                            <td class="{% if result.status == 'Accepted' %}text-success{% else %}text-danger{% endif %}">
                                <strong>{{ result.status }}</strong>
                                {% if result.error_message %}<pre class="text-danger mt-1" style="font-size: 0.8em;">{{ result.error_message }}</pre>{% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-secondary">
                You have not made any submissions for this problem yet.
            </div>
        {% endif %}
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const languageModes = { "python": "python", "c": "text/x-csrc", "cpp": "text/x-c++src", "java": "text/x-java", "javascript": "javascript" };
        const textarea = document.getElementById("code-editor");
        const form = document.getElementById("code-submit-form");
        const submitBtn = form.querySelector("button[type='submit']");
        const languageSelect = document.getElementById("language-select");
        const resultsContainer = document.getElementById('results-container');

        const editor = CodeMirror.fromTextArea(textarea, { mode: languageModes[languageSelect.value] || "python", lineNumbers: true, theme: "dracula", indentUnit: 4, matchBrackets: true, autoCloseBrackets: true, extraKeys: { "Ctrl-Space": "autocomplete" } });
        window.editor = editor;

        // --- FINAL SUBMISSION LOGIC ---
        form.addEventListener("submit", function (e) {
            e.preventDefault(); // Always prevent the default page refresh
            textarea.value = editor.getValue();

            if (!editor.getValue().trim()) {
                alert("Code cannot be empty!");
                return;
            }

            // 1. Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...`;
            resultsContainer.innerHTML = `<div class="alert alert-info" id="pending-submission"><div class="spinner-border spinner-border-sm" role="status"></div><strong> Processing your submission...</strong></div>`;

            // 2. Submit the form in the background
            const formData = new FormData(form);
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': "{{ csrf_token }}" }
            })
            .then(response => {
                // Check if the response is valid JSON before trying to parse it
                const contentType = response.headers.get("content-type");
                if (response.ok && contentType && contentType.indexOf("application/json") !== -1) {
                    return response.json();
                } else {
                    // If it's not JSON, it's an error. Show the HTML error for debugging.
                    return response.text().then(text => { 
                        throw new Error("Server did not return JSON. This often means you are not logged in or a server error occurred. Response: " + text);
                    });
                }
            })
            .then(data => {
                // 3. On success, use the new submission_id to open the WebSocket
                if (data.submission_id) {
                    connectToWebSocket(data.submission_id);
                } else {
                    throw new Error(data.error || "Failed to get submission ID.");
                }
            })
            .catch(error => {
                console.error('Error submitting form:', error);
                resultsContainer.innerHTML = `<div class="alert alert-danger"><strong>Submission Error:</strong> ${error.message.split('Response: ')[0]}<br><small>Check the browser console for more details.</small></div>`;
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Submit';
            });
        });
        // --- END OF SUBMISSION LOGIC ---

        // (Custom run button logic remains the same)
        const runBtn = document.getElementById("run-custom-btn");
        const outputBox = document.getElementById("custom-output");
        const customInputBox = document.getElementById("custom-input");
        runBtn.addEventListener("click", () => {
            const code = editor.getValue(), language = languageSelect.value, custom_input = customInputBox.value;
            outputBox.textContent = "⏳ Running..."; runBtn.disabled = true;
            fetch("{% url 'run_code' %}", { method: "POST", headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" }, body: JSON.stringify({ code: code, language: language, stdin: custom_input }) })
                .then(res => res.json())
                .then(data => { outputBox.textContent = data.error ? `❌ Error:\\n${data.error}` : `✅ Output:\\n${data.output}`; })
                .catch(err => { outputBox.textContent = "⚠️ Failed to execute code."; console.error(err); })
                .finally(() => { runBtn.disabled = false; });
        });

        // --- WEBSOCKET CONNECTION LOGIC ---
        function connectToWebSocket(submissionId) {
            const socketProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const socketURL = `${socketProtocol}//${window.location.host}/ws/submission/${submissionId}/`;
            const submissionSocket = new WebSocket(socketURL);

            submissionSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                let resultsHtml = `<div class="table-responsive"><table class="table table-bordered"><thead class="thead-dark"><tr><th>Input</th><th>Expected Output</th><th>Actual Output</th><th>Status</th></tr></thead><tbody>`;
                (data.results || []).forEach(result => {
                    const statusClass = result.status === 'Accepted' ? 'text-success' : 'text-danger';
                    const expectedOutput = (result.expected_output || []).join('\\n');
                    const actualOutput = (result.actual_output || []).join('\\n');
                    const input = result.input || '(No Input)';
                    const errorMsg = result.error_message ? `<pre class="text-danger mt-1" style="font-size: 0.8em;">${result.error_message}</pre>` : '';
                    resultsHtml += `<tr><td><pre>${input}</pre></td><td><pre>${expectedOutput}</pre></td><td><pre>${actualOutput}</pre></td><td class="${statusClass}"><strong>${result.status}</strong>${errorMsg}</td></tr>`;
                });
                resultsHtml += `</tbody></table></div>`;
                
                resultsContainer.innerHTML = resultsHtml;
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Submit';
                submissionSocket.close();
            };

            submissionSocket.onclose = function(e) { console.log('Submission socket closed.'); };
            submissionSocket.onerror = function(e) { 
                console.error('WebSocket error:', e);
                resultsContainer.innerHTML = `<div class="alert alert-danger">Real-time connection failed. Please refresh to see results.</div>`;
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Submit';
            };
        }

        // Connect to WebSocket on initial page load if needed
        const initialSubmissionId = "{{ submission.id }}";
        const initialSubmissionStatus = "{{ submission.status }}";
        if (initialSubmissionId && initialSubmissionStatus === 'Pending') {
            connectToWebSocket(initialSubmissionId);
        }
    });
</script>
{% endblock %}