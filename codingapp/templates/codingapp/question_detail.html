{% extends 'codingapp/base.html' %}
{% load form_filters %}

{% block title %}{{ question.title }}{% endblock %}

{% block content %}
<div class="main-content-card p-4">
    
    <h4 class="text-primary">{{ question.title }}</h4>
    <p>{{ question.description|linebreaksbr }}</p>

    <h3>Submit Your Code:</h3>
    
    <form id="submission-form" method="post"> 
        {% csrf_token %}
        
        <div class="mb-3 d-flex align-items-center">
            <label for="language-select" class="form-label me-2 mb-0"><strong>Select Language:</strong></label>
            
            <select id="language-select" name="language" class="form-control" style="width: auto;">
                {% for lang_key in supported_languages %}
                    <option value="{{ lang_key }}" {% if lang_key == selected_language %}selected{% endif %}>{{ lang_key|capfirst }}</option>
                {% endfor %}
            </select>
        </div>

        <textarea id="code-editor" name="code" style="display: none;">{{ code|escape }}</textarea>

        <button type="submit" id="submit-btn" class="btn btn-primary mt-2">
            Submit Code
        </button>
    </form>

    <hr class="border-secondary">
    
    {% if task_id %}
    <div id="polling-status-message" class="alert alert-info" role="alert">
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        Submission received. Status: PENDING (Running tests in background...)
    </div>
    {% endif %}

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} mt-2">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <h4 id="results-title" class="mt-4 text-primary d-none">Test Case Results:</h4>
    <div id="results-container" class="table-responsive">
    </div>
    
    <h4 class="mt-4 text-primary">Try with Custom Input</h4>
    <div>
        <div class="mb-3">
            <label for="custom-input" class="form-label">Enter Custom Input</label>
            <textarea id="custom-input" rows="4" class="form-control font-monospace" placeholder="Enter your input here..."></textarea>
        </div>
        <button id="run-custom-btn" class="btn btn-outline-secondary">Run Code</button>

        <pre id="custom-output" class="bg-dark border border-secondary p-3 mt-3" style="white-space: pre-wrap;">Output will appear here.</pre>
    </div>
</div>

{{ results|json_script:"initial-results-data" }}
{{ user_submissions|json_script:"user-submissions-data" }}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    // --- Configuration ---
    const languageModes = {
        "python": "python",
        "c": "text/x-csrc",
        "cpp": "text/x-c++src",
        "java": "text/x-java",
        "javascript": "javascript"
    };

    const API_RUN_URL = "{% url 'run_code' %}";
    const API_STATUS_URL = "{% url 'check_submission_status' task_id='DUMMY_TASK_ID' %}";
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // --- DOM Elements ---
    const submissionForm = document.getElementById('submission-form');
    const submitBtn = document.getElementById('submit-btn');
    const languageSelect = document.getElementById("language-select");
    const textarea = document.getElementById("code-editor");
    const resultsTitle = document.getElementById('results-title');
    const resultsContainer = document.getElementById('results-container');
    const pollingMessageContainer = document.getElementById('polling-status-message');
    const initialTaskId = "{{ task_id }}";

    // --- CodeMirror Setup ---
    const editor = CodeMirror.fromTextArea(textarea, {
        mode: languageModes[languageSelect.value] || "python",
        lineNumbers: true,
        theme: "dracula",
        indentUnit: 4,
        matchBrackets: true,
        autoCloseBrackets: true,
        readOnly: false
    });
    editor.setValue(textarea.value);

    // --- Parse per-language code map from backend ---
    let codeMap = {};
    const codeMapElem = document.getElementById('user-submissions-data');
    if (codeMapElem) {
        try {
            codeMap = JSON.parse(codeMapElem.textContent) || {};
        } catch (e) {
            console.error("Could not parse user_submissions JSON:", e);
            codeMap = {};
        }
    }

    // --- Set initial code from codeMap (if exists) ---
    if (codeMap[languageSelect.value]) {
        editor.setValue(codeMap[languageSelect.value]);
    }

    // --- Language Change Handling ---
    languageSelect.addEventListener("change", function() {
        const newLang = this.value;
        const currentLang = editor.getOption("mode");

        // Reverse lookup current language key
        const reverseMap = Object.fromEntries(Object.entries(languageModes).map(([k, v]) => [v, k]));
        const currentLangKey = reverseMap[currentLang] || languageSelect.value;

        // Save current code to memory
        codeMap[currentLangKey] = editor.getValue();

        // Update mode and load saved/new code
        editor.setOption("mode", languageModes[newLang]);
        editor.setValue(codeMap[newLang] || "");
    });

    // --- Render Test Results ---
    function renderResults(results) {
        if (!results || results.length === 0) {
            resultsTitle.classList.add('d-none');
            resultsContainer.innerHTML = '';
            return;
        }

        const acceptedCount = results.filter(r => r.status === 'Accepted').length;
        const totalCount = results.length;
        resultsTitle.textContent = `Test Case Results: ${acceptedCount} / ${totalCount} Passed`;
        resultsTitle.classList.remove('d-none');

        let html = `<table class="table table-bordered table-dark">
            <thead><tr><th>Input</th><th>Expected Output</th><th>Your Output</th><th>Status</th></tr></thead><tbody>`;
        results.forEach(r => {
            const statusClass = r.status === 'Accepted' ? 'text-success' : 'text-danger';
            const exp = (r.expected_output || []).join('\n');
            const out = (r.actual_output || []).join('\n');
            const err = r.error_message ? `<pre class="text-danger small">${r.error_message}</pre>` : '';
            html += `<tr>
                <td><pre>${r.input}</pre></td>
                <td><pre>${exp}</pre></td>
                <td><pre>${out}</pre></td>
                <td class="${statusClass}">${r.status}${err}</td>
            </tr>`;
        });
        html += `</tbody></table>`;
        resultsContainer.innerHTML = html;
    }

    // --- Handle Form Submit ---
    submissionForm.addEventListener('submit', function(e) {
        editor.save();
        const code = editor.getValue().trim();
        if (!code) {
            e.preventDefault();
            alert("Code cannot be empty!");
            return;
        }

        // Save current code in memory
        codeMap[languageSelect.value] = code;

        submitBtn.disabled = true;
        submitBtn.innerHTML = `
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Submitting...
        `;
    });

    // --- Custom Input Execution ---
    const runBtn = document.getElementById("run-custom-btn");
    const outputBox = document.getElementById("custom-output");
    const customInputBox = document.getElementById("custom-input");

    runBtn.addEventListener("click", () => {
        const code = editor.getValue();
        const lang = languageSelect.value;
        const custom_input = customInputBox.value;

        outputBox.textContent = "⏳ Running...";
        runBtn.disabled = true;

        fetch(API_RUN_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
            body: JSON.stringify({ code: code, language: lang, stdin: custom_input })
        })
        .then(res => res.json())
        .then(data => {
            outputBox.textContent = data.error ? `❌ Error:\n${data.error}` : `✅ Output:\n${data.output}`;
        })
        .catch(err => {
            console.error(err);
            outputBox.textContent = "⚠️ Failed to execute code.";
        })
        .finally(() => {
            runBtn.disabled = false;
        });
    });

    // --- Async Polling for Background Tasks ---
    if (initialTaskId && initialTaskId !== 'None') {
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Processing...
        `;

        const url = API_STATUS_URL.replace('DUMMY_TASK_ID', initialTaskId);
        const intervalId = setInterval(() => {
            fetch(url)
                .then(r => r.json())
                .then(data => {
                    if (pollingMessageContainer) {
                        pollingMessageContainer.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span> Submission processing... Status: ${data.status}`;
                    }
                    if (data.ready) {
                        clearInterval(intervalId);
                        window.location.reload();
                    }
                })
                .catch(err => {
                    console.error("Polling error:", err);
                    clearInterval(intervalId);
                    if (pollingMessageContainer) pollingMessageContainer.textContent = 'Error checking status.';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Code';
                });
        }, 2000);
    }

    // --- Initial Results Display ---
    const resultsDataElem = document.getElementById('initial-results-data');
    if (resultsDataElem) {
        try {
            const initialResults = JSON.parse(resultsDataElem.textContent);
            if (initialResults) renderResults(initialResults);
        } catch (e) {
            console.error("Could not parse initial results JSON.", e);
        }
    }
});
</script>
{% endblock %}
