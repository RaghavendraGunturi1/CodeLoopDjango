{% extends "codingapp/base.html" %}

{% block title %}
    {% if form.instance.pk %}Edit Module{% else %}Add Module{% endif %}
{% endblock %}

{% block content %}
<div class="card p-4 mx-auto" style="max-width: 900px;">
    <h2>{% if form.instance.pk %}Edit Module{% else %}Add Module{% endif %}</h2>
    
    {% if form.errors %}
        <div class="alert alert-danger" role="alert">
            <ul>
                {% for field in form %}
                    {% for error in field.errors %}
                        <li>{{ field.label }}: {{ error }}</li>
                    {% endfor %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    <form method="post" id="module-form">
        {% csrf_token %}
        
        <div class="mb-3">
            <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>
            {{ form.title }}
        </div>
        <div class="mb-3">
            <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
            {{ form.description }}
        </div>

        <div class="mb-3 form-check">
            {{ form.is_public }}
            <label class="form-check-label" for="{{ form.is_public.id_for_label }}">
                {{ form.is_public.label }}
            </label>
        </div>

        <div class="mb-3">
            <label class="form-label">{{ form.groups.label }}</label>
            <small class="text-muted d-block mb-1">Hold <strong>Shift</strong> to select multiple groups.</small>
            <div class="form-control group-checkbox-container" style="max-height: 200px; overflow-y: auto;">
                {% for checkbox in form.groups %}
                    <div class="form-check">
                        {{ checkbox.tag }}
                        <label class="form-check-label" for="{{ checkbox.id_for_label }}">
                            {{ checkbox.choice_label }}
                        </label>
                    </div>
                {% endfor %}
            </div>
            <div class="form-text text-muted small">{{ form.groups.help_text }}</div>
            {% for error in form.groups.errors %}
                <div class="text-danger small">{{ error }}</div>
            {% endfor %}
        </div>
        
        {% if formset %}
            {% endif %}

        <div class="d-flex gap-2 mt-3">
            <button type="submit" class="btn btn-success">Save</button>
            <a href="{% url 'module_list' %}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let lastChecked = null;
        const checkboxes = document.querySelectorAll('.group-checkbox-container input[type="checkbox"]');

        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('click', function(e) {
                if (!lastChecked) {
                    lastChecked = this;
                    return;
                }

                if (e.shiftKey) {
                    let start = Array.from(checkboxes).indexOf(this);
                    let end = Array.from(checkboxes).indexOf(lastChecked);

                    // Swap if start is greater than end
                    if (start > end) {
                        [start, end] = [end, start];
                    }

                    // Check all boxes in the range
                    for (let i = start; i <= end; i++) {
                        checkboxes[i].checked = this.checked;
                    }
                }

                lastChecked = this;
            });
        });
    });
</script>
{% endblock %}