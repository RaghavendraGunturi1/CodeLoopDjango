{% extends 'codingapp/base.html' %}

{% block extra_css %}
<style>
    /* Distraction-free mode styles */
    .sidebar-nav { display: none !important; }
    .main-content { margin-left: 0 !important; padding: 1rem !important; height: 100vh; overflow-y: auto; }
    body { overflow: hidden; }
</style>
{% endblock %}

{% block content %}
<div id="assessment-container" class="container-fluid">

    <div class="card p-3 mb-3 sticky-top">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0">{{ assessment.title }}</h4>
            <div class="d-flex align-items-center">
                <strong class="me-3 text-warning">Warnings: <span id="warning-count">0</span> / 3</strong>
                <strong class="me-3">Time Left: <span id="assessment-timer" class="text-danger fw-bold h5"></span></strong>
                <a href="{% url 'assessment_result' assessment.id %}" id="end-assessment-btn" class="btn btn-danger">End Assessment</a>
            </div>
        </div>
        <hr class="my-2">
        <div id="question-nav-bar" class="d-flex flex-wrap gap-2">
            {% for q_item in all_questions %}
                <a href="{% url 'submit_assessment_code' assessment.id q_item.question.id %}" class="btn btn-sm {% if q_item.is_solved %}btn-success{% elif q_item.is_attempted %}btn-warning{% else %}btn-outline-secondary{% endif %}" title="{{ q_item.question.title }}">
                   {{ forloop.counter }}
                </a>
            {% empty %}
                <span class="text-muted">No coding questions in this assessment.</span>
            {% endfor %}
        </div>
    </div>

    <div class="card p-4">
        {% block assessment_content %}{% endblock %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Make 'editor' a global variable so child templates can assign to it
var editor;

document.addEventListener("DOMContentLoaded", function () {
    const MAX_WARNINGS = 3;
    const warningCountEl = document.getElementById('warning-count');
    const timerElement = document.getElementById("assessment-timer");
    const endAssessmentBtn = document.getElementById('end-assessment-btn');
    
    // Use a unique key for this user & assessment. Using localStorage for persistence across reloads.
    const warningStorageKey = `assessmentWarnings_{{ assessment.id }}_{{ user.id }}`;

    // --- DEFINITIVE RELOAD & TAB-SWITCH FIX ---
    function handleVisibilityChange() {
        // Check if the page is unloading due to an intentional action.
        if (sessionStorage.getItem('isUnloading')) {
            return; // Ignore this visibility change event
        }

        if (document.hidden) {
            let currentWarnings = parseInt(localStorage.getItem(warningStorageKey) || '0');
            currentWarnings++;
            localStorage.setItem(warningStorageKey, currentWarnings);
            updateWarningDisplay(currentWarnings);

            if (currentWarnings > MAX_WARNINGS) {
                document.removeEventListener('visibilitychange', handleVisibilityChange);
                alert('You have exceeded the maximum number of tab switches. Your assessment will now be submitted.');
                clearAssessmentState(); // Clear storage before redirecting
                window.location.href = `{% url 'assessment_result' assessment.id %}?ended=auto`;
            }
        }
    }

    function updateWarningDisplay(count) {
        if (warningCountEl) {
            warningCountEl.textContent = count;
        }
    }

    // This event fires just before the page unloads for any navigation.
    window.addEventListener('beforeunload', function() {
        sessionStorage.setItem('isUnloading', 'true');
    });

    // When the new page loads, clear the flag.
    sessionStorage.removeItem('isUnloading');

    function clearAssessmentState() {
        localStorage.removeItem(warningStorageKey);
        sessionStorage.removeItem('isUnloading');
    }

    endAssessmentBtn.addEventListener('click', clearAssessmentState);
    
    // Initialize warning count display on page load
    updateWarningDisplay(parseInt(localStorage.getItem(warningStorageKey) || '0'));
    
    document.addEventListener('visibilitychange', handleVisibilityChange);

    // Timer logic
    const endTime = new Date("{{ end_time|escapejs }}").getTime();
    const timerInterval = setInterval(() => {
        const now = new Date().getTime();
        let timeLeft = Math.floor((endTime - now) / 1000);
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            clearAssessmentState(); // Clear storage on timeout
            alert("Time's up!");
            window.location.href = "{% url 'assessment_result' assessment.id %}";
            return;
        }
        const hours = Math.floor(timeLeft / 3600),
              minutes = Math.floor((timeLeft % 3600) / 60),
              seconds = timeLeft % 60;
        timerElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
});
</script>
{% block assessment_extra_js %}{% endblock %}
{% endblock %}