{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}CodingLoop{% endblock %}</title>

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">

  <!-- CodeMirror JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/javascript-hint.min.js"></script>
  <script src="https://cdn.ckeditor.com/ckeditor5/41.1.0/classic/ckeditor.js"></script>


<style>
  :root,
  [data-bs-theme="light"] {
    --bs-body-bg: #fafafa;
    --bs-body-color: #212529;
    --sidebar-bg: #222;
    --sidebar-link-color: #fff;
    --sidebar-link-active-bg: #35373c;
  }

  [data-bs-theme="dark"] {
    --bs-body-bg: #121212;
    --bs-body-color: #f8f9fa;
    --sidebar-bg: #1f1f1f;
    --sidebar-link-color: #ccc;
    --sidebar-link-active-bg: #333;
  }

  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
  }

  body {
    min-height: 100vh;
    overflow-x: hidden;
    background-color: var(--bs-body-bg);
    color: var(--bs-body-color);
  }

  #splash-screen {
    position: fixed;
    inset: 0;
    background: black;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #splash-screen.hidden {
    display: none !important;
  }

  /* Sidebar styles */
  .sidebar-nav {
    height: 100vh;
    position: fixed;
    left: 0;
    top: 0;
    width: 240px;
    background: var(--sidebar-bg);
    color: var(--sidebar-link-color);
    overflow-y: auto;
    z-index: 1040;
    display: flex;
    flex-direction: column;
    padding-bottom: 0.5rem;
  }

  .sidebar-nav .nav-link {
    color: var(--sidebar-link-color);
    border-radius: 1rem;
    transition: background 0.2s, color 0.2s;
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 1.07rem;
    padding: 0.8rem 1rem 0.8rem 1.2rem;
    margin-bottom: 2px;
    font-weight: 500;
  }

  .sidebar-nav .nav-link.active,
  .sidebar-nav .nav-link:active,
  .sidebar-nav .nav-link:focus {
    background: var(--sidebar-link-active-bg) !important;
    color: #fff !important;
    font-weight: bold;
    box-shadow: 0 2px 8px rgba(20,20,20,0.04);
    border-left: 4px solid #44b2ff;
  }

  .sidebar-nav .nav-link .bi {
    min-width: 20px;
    min-height: 20px;
    font-size: 1.23em;
  }

  .sidebar-nav .nav-link .bi-chevron-down {
    transition: transform 0.2s;
  }

  .sidebar-nav .nav-link.collapsed .bi-chevron-down {
    transform: rotate(-90deg);
  }

  .sidebar-footer {
    position: sticky;
    bottom: 0;
    background: var(--sidebar-bg);
    z-index: 1100;
    padding-top: 0.6rem;
    padding-bottom: 0.8rem;
  }

  .sidebar-nav .form-switch .form-check-label {
    padding-left: 10px;
  }

  .main-content {
    margin-left: 240px;
    min-height: 100vh;
    padding: 2rem;
    background: var(--bs-body-bg);
    overflow-y: auto;
  }

  @media (max-width: 991.98px) {
    .sidebar-nav {
      position: relative;
      width: 100%;
      height: auto;
      z-index: 100;
    }
    .main-content {
      margin-left: 0;
      padding: 1rem;
    }
  }

  .main-content, .sidebar-nav {
    box-sizing: border-box;
  }
</style>

  {% block extra_css %}{% endblock %}
</head>

<body>
  <!-- Splash Screen -->
  <div id="splash-screen">
    <video id="splash-video" autoplay muted playsinline style="max-width: 100vw; max-height: 100vh; object-fit: contain;">
      <source src="{% static 'videos/animation.mp4' %}" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </div>

  <!-- Sidebar -->
  <nav class="sidebar-nav">
    <div class="mb-4 text-center">
      <a class="d-flex align-items-center gap-2 text-decoration-none text-white" href="{% url 'home' %}">
        <img src="{% static 'images/logo.png' %}" alt="CodeLoop Logo" style="height: 32px;">
        <span class="fw-bold">CodeLoop</span>
      </a>
    </div>
    <ul class="nav flex-column flex-grow-1">
      {% if user.is_authenticated %}
        <li class="nav-item mb-2">
          <a class="nav-link {% if request.path == '/dashboard/' %}active{% endif %}" href="{% url 'dashboard' %}">
            <i class="bi bi-speedometer2 me-2"></i>Dashboard
          </a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link {% if request.path == '/modules/' %}active{% endif %}" href="{% url 'module_list' %}">
            <i class="bi bi-box-seam me-2"></i>Modules
          </a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link {% if request.path == '/notes/' %}active{% endif %}" href="{% url 'notes_list' %}">
            <i class="bi bi-journal-text me-2"></i>Notes
          </a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link {% if request.path == '/notices/' %}active{% endif %}" href="{% url 'notice_list' %}">
            <i class="bi bi-bell me-2"></i>Notice Board
            {% if unread_notice_count and unread_notice_count > 0 %}
              <span class="badge bg-danger ms-1">{{ unread_notice_count }}</span>
            {% endif %}
          </a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link {% if '/courses/' in request.path %}active{% endif %}" href="{% url 'course_list' %}">
            <i class="bi bi-journal-code me-2"></i>Courses
          </a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link {% if request.path == '/profile/edit/' %}active{% endif %}" href="{% url 'edit_profile' %}">
            <i class="bi bi-person me-2"></i>My Profile
          </a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link {% if request.path == '/questions/' %}active{% endif %}" href="{% url 'question_list' %}">
            <i class="bi bi-question-circle me-2"></i>Questions
          </a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link {% if request.path == '/assessments/' %}active{% endif %}" href="{% url 'assessment_list' %}">
            <i class="bi bi-check2-square me-2"></i>Assessments
          </a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link {% if request.path == '/leaderboard/' %}active{% endif %}" href="{% url 'leaderboard' %}">
            <i class="bi bi-trophy me-2"></i>Leaderboard
          </a>
        </li>
        {% if user.is_staff %}
        <li class="nav-item mb-2 sidebar-collapse">
          <a class="nav-link d-flex align-items-center" data-bs-toggle="collapse" href="#manageMenu" role="button">
            <i class="bi bi-gear me-2"></i>Manage Content <i class="bi bi-chevron-down ms-auto"></i>
          </a>
          <div class="collapse show" id="manageMenu">
            <ul class="nav flex-column ms-3">
              <li class="nav-item">
                <a class="nav-link {% if request.path == '/notices/add/' %}active{% endif %}" href="{% url 'add_notice' %}">
                  <i class="bi bi-plus-circle me-2"></i>Add Notice
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if request.path == '/teacher/student-performance/' %}active{% endif %}"
                  href="{% url 'student_performance_list' %}">
                  <i class="bi bi-graph-up me-2"></i>Student Performance
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if request.path == '/teacher/modules/' %}active{% endif %}" href="{% url 'teacher_module_list' %}">
                  <i class="bi bi-box-seam me-2"></i>Manage Modules
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if request.path == '/teacher/assessments/' %}active{% endif %}" href="{% url 'teacher_assessment_list' %}">
                  <i class="bi bi-check2-square me-2"></i>Manage Assessments
                </a>
              </li>
              <li><a href="{% url 'manage_courses' %}" class="nav-link {% if '/courses/manage/' in request.path %}active{% endif %}"><i class="bi bi-journal-code me-2"></i>
                  Manage Courses
              </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if request.path == '/teacher/groups/' %}active{% endif %}" href="{% url 'teacher_group_list' %}">
                  <i class="bi bi-people me-2"></i>Manage Groups
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if request.path == '/teacher/questions/' %}active{% endif %}" href="{% url 'teacher_question_list' %}">
                  <i class="bi bi-question-circle me-2"></i>Manage Questions
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if request.path == '/notes/' %}active{% endif %}" href="{% url 'notes_list' %}">
                  <i class="bi bi-journal-text me-2"></i>Manage Notes
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if request.path == '/notes/add/' %}active{% endif %}" href="{% url 'add_note' %}">
                  <i class="bi bi-plus-circle me-2"></i>Add Notes
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if request.path == '/bulk-user-upload/' %}active{% endif %}" href="{% url 'bulk_user_upload' %}">
                  <i class="bi bi-upload me-2"></i>Bulk User Upload
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if request.path == '/bulk-mcq-upload/' %}active{% endif %}" href="{% url 'bulk_mcq_upload' %}">
                  <i class="bi bi-upload me-2"></i>Bulk MCQ Upload
                </a>
              </li>
            </ul>
          </div>
        </li>
        {% endif %}
        <li class="nav-item sidebar-footer">
          <form method="post" action="{% url 'logout' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-link nav-link p-0">
              <i class="bi bi-box-arrow-right me-2"></i>Logout
            </button>
          </form>
        </li>
      {% else %}
        <li class="nav-item mb-2">
          <a class="nav-link" href="{% url 'login' %}">
            <i class="bi bi-box-arrow-in-right me-2"></i>Login
          </a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link" href="{% url 'register' %}">
            <i class="bi bi-person-plus me-2"></i>Register
          </a>
        </li>
      {% endif %}
    </ul>
    <div class="sidebar-footer">
      <div class="form-check form-switch ps-0">
        <input class="form-check-input" type="checkbox" id="themeSwitch">
        <label class="form-check-label text-white" for="themeSwitch">
          <i class="bi bi-moon me-2"></i>Dark Mode
        </label>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="main-content">
    {% block content %}{% endblock %}
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <script>
    AOS.init();

    document.addEventListener("DOMContentLoaded", function () {
      const themeToggle = document.getElementById("themeSwitch");
      const root = document.documentElement;
      const savedTheme = localStorage.getItem("theme") || "light";

      root.setAttribute("data-bs-theme", savedTheme);
      themeToggle.checked = (savedTheme === "dark");

      themeToggle.addEventListener("change", function () {
        const mode = this.checked ? "dark" : "light";
        root.setAttribute("data-bs-theme", mode);
        localStorage.setItem("theme", mode);
      });
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const splash = document.getElementById('splash-screen');
      const video = document.getElementById('splash-video');
      const forceSplash = "{{ request.session.force_splash|yesno:'true,false' }}" === "true";

      function hideSplash() {
        splash?.classList.add("hidden");
      }

      if (forceSplash) {
        if (video) {
          video.addEventListener("ended", hideSplash);
          video.play().catch(() => setTimeout(hideSplash, 5000));
        }
        setTimeout(hideSplash, 8000);
        fetch("{% url 'clear_splash_flag' %}").catch(() => {});
      } else {
        hideSplash();
      }
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      anime({
        targets: '.anime-navbar',
        opacity: [0, 1],
        translateY: [40, 0],
        duration: 1000,
        delay: 300,
        easing: 'easeOutExpo'
      });
      anime({
        targets: '.anime-content',
        opacity: [0, 1],
        translateY: [40, 0],
        duration: 1000,
        delay: 300,
        easing: 'easeOutExpo'
      });
    });
  </script>

  {% block extra_js %}{% endblock %}
  {% block extra_scripts %}{% endblock %}
</body>
</html>
