{% extends "codingapp/base.html" %}
{% load static %}
{% block content %}

<div class="container mt-4">
  <h2 class="mb-3">üîê Permissions ‚Äî Manage by User</h2>
<!-- Search Bar -->
<div class="card mb-4 shadow-sm">
  <div class="card-header bg-info text-dark">
    <h5 class="mb-0">üîç Search Users</h5>
  </div>
  <div class="card-body">
    <form method="GET" class="d-flex">
      <input
        type="text"
        name="search"
        value="{{ request.GET.search|default_if_none:'' }}"
        class="form-control me-2"
        placeholder="Search by username, email, or role..."
      >
      <button type="submit" class="btn btn-primary">Search</button>
      {% if request.GET.search %}
        <a href="{% url 'permissions_manage' %}" class="btn btn-secondary ms-2">Clear</a>
      {% endif %}
    </form>
  </div>
</div>

  {% for message in messages %}
    <div class="alert alert-info">{{ message }}</div>
  {% endfor %}

  <div class="row gx-4">
    <!-- LEFT: User list -->
    <div class="col-md-4">
  <div class="card shadow-sm">
    <div class="card-header">
      <strong>Users</strong>
      <small class="text-muted ms-2">(click to edit permissions)</small>
    </div>

    <div class="accordion" id="userAccordion">
      {% regroup users by role.name|default:"Unassigned" as grouped_users %}
      {% for group in grouped_users %}
      {% with group_id=group.grouper|slugify %}
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading-{{ group_id }}">
          <button class="accordion-button collapsed" type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapse-{{ group_id }}"
                  aria-expanded="false"
                  aria-controls="collapse-{{ group_id }}">
            {{ group.grouper|title }}
            <span class="badge bg-secondary ms-2">{{ group.list|length }}</span>
          </button>
        </h2>

        <div id="collapse-{{ group_id }}" class="accordion-collapse collapse"
             aria-labelledby="heading-{{ group_id }}"
             data-bs-parent="#userAccordion">
          <div class="accordion-body p-0">
            <div class="list-group list-group-flush" style="max-height: 300px; overflow:auto;">
              {% for user in group.list %}
                <button type="button"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center user-entry"
                        data-user-id="{{ user.id }}">
                  <div>
                    <strong>{{ user.user.username }}</strong>
                    <div class="small text-muted">
                      {{ user.department.name|default:"‚Äî" }}
                    </div>
                  </div>
                  <span class="badge bg-dark">{{ user.user.email|default:"‚Äî" }}</span>
                </button>
              {% empty %}
                <div class="list-group-item">No users found.</div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      {% endwith %}
      {% endfor %}
    </div>
  </div>
</div>


    <!-- RIGHT: Permission editor for selected user -->
    <div class="col-md-8">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <strong id="selected-username">Select a user</strong>
            <div class="small text-muted" id="selected-role">‚Äî</div>
          </div>
          <div>
            <button id="select-all-btn" class="btn btn-sm btn-outline-primary me-2" disabled>Select all</button>
            <button id="clear-all-btn" class="btn btn-sm btn-outline-secondary me-2" disabled>Clear all</button>
            <button id="save-perms-btn" class="btn btn-sm btn-success" disabled>Save</button>
          </div>
        </div>

        <div class="card-body">
          <p class="text-muted">Edit <strong>custom permissions</strong> for a user. Inherited (role) permissions are shown separately and cannot be changed here.</p>

          <div class="row">
            <!-- Inherited permissions (read-only) -->
            <div class="col-md-6 mb-3">
              <div class="card bg-light text-dark h-100">
                <div class="card-header">
                  <strong>Inherited (Role) Permissions</strong>
                </div>
                <div class="card-body" style="max-height:52vh; overflow:auto;">
                  <ul class="list-unstyled" id="inherited-perms">
                    <!-- populated by JS -->
                    <li class="text-muted">Select a user to view inherited permissions.</li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Custom permissions (editable) -->
            <div class="col-md-6 mb-3">
              <form id="custom-perms-form" method="POST" action="{% url 'permissions_manage' %}">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_user_perms">
                <input type="hidden" name="user_id" id="form-user-id" value="">

                <div class="card bg-light text-dark h-100">
                  <div class="card-header">
                    <strong>Custom Permissions</strong>
                    <div class="small text-muted">Select multiple (Shift/Ctrl) & click Save</div>
                  </div>

                  <div class="card-body" style="max-height:52vh; overflow:auto;">
                    <div class="mb-2">
                      <input type="search" id="perm-filter" class="form-control form-control-sm" placeholder="Filter permissions...">
                    </div>

                    <div id="custom-perms-list">
                      {% for perm in permissions %}
                        {# Determine if this perm is custom for any user later; initially render with data attributes #}
                        <div class="form-check permission-item" data-perm-id="{{ perm.id }}">
                          <input class="form-check-input perm-checkbox" type="checkbox" name="perm_ids" value="{{ perm.id }}" id="perm-{{ perm.id }}">
                          <label class="form-check-label" for="perm-{{ perm.id }}">{{ perm.name }} <small class="text-muted">({{ perm.code }})</small></label>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>

        </div> <!-- card-body -->
      </div> <!-- card -->
    </div> <!-- col -->
  </div> <!-- row -->
</div> <!-- container -->

<script>
document.addEventListener('DOMContentLoaded', function () {
  // Precomputed maps passed by Django via HTML dataset (we can output JSON-encoded into the template if needed)
  const rolePermMap = JSON.parse('{{ role_perm_json|escapejs }}');
  const customPermMap = JSON.parse('{{ custom_perm_json|escapejs }}');
  const userList = document.querySelectorAll('.user-entry');
  const selectedUsername = document.getElementById('selected-username');
  const selectedRole = document.getElementById('selected-role');
  const inheritedList = document.getElementById('inherited-perms');
  const customPermsList = document.getElementById('custom-perms-list');
  const formUserId = document.getElementById('form-user-id');
  const saveBtn = document.getElementById('save-perms-btn');
  const selectAllBtn = document.getElementById('select-all-btn');
  const clearAllBtn = document.getElementById('clear-all-btn');
  const permFilter = document.getElementById('perm-filter');

  let activeUserId = null;
  let lastChecked = null; // for shift-selection (works across the permission list, per active user)

  // Helper to clear all checks in custom-perms
  function clearCustomChecks() {
    document.querySelectorAll('#custom-perms-list .perm-checkbox').forEach(cb => cb.checked = false);
  }

  // Helper to set checks according to customPermMap[userId]
  function setCustomChecksForUser(uid) {
    clearCustomChecks();
    const setIds = new Set((customPermMap[uid] || []).map(Number));
    document.querySelectorAll('#custom-perms-list .perm-checkbox').forEach(cb => {
      cb.checked = setIds.has(Number(cb.value));
    });
  }

  // Populate inherited list for user
  function populateInherited(uid) {
    inheritedList.innerHTML = '';
    const ids = rolePermMap[uid] || [];
    if (!ids || ids.length === 0) {
      inheritedList.innerHTML = '<li class="text-muted">No inherited permissions for this user\'s role.</li>';
      return;
    }
    // For each perm id find label text from DOM
    ids.forEach(pid => {
      const item = document.querySelector('#custom-perms-list .permission-item[data-perm-id="'+pid+'"]');
      if (item) {
        const label = item.querySelector('label').innerHTML;
        const li = document.createElement('li');
        li.innerHTML = `<i class="bi bi-check2-circle text-success me-2"></i> ${label}`;
        inheritedList.appendChild(li);
      }
    });
  }

  // When user clicked in left list
  userList.forEach(btn => {
    btn.addEventListener('click', function () {
      // mark active
      userList.forEach(x => x.classList.remove('active'));
      this.classList.add('active');

      activeUserId = this.dataset.userId;
      formUserId.value = activeUserId;

      // update header
      selectedUsername.textContent = this.querySelector('strong').textContent;
      selectedRole.textContent = this.querySelector('.small.text-muted').textContent;

      // enable buttons
      saveBtn.removeAttribute('disabled');
      selectAllBtn.removeAttribute('disabled');
      clearAllBtn.removeAttribute('disabled');

      // populate lists
      populateInherited(activeUserId);
      setCustomChecksForUser(activeUserId);

      // reset lastChecked
      lastChecked = null;
    });
  });

  // Shift/Ctrl selection logic inside permission list
  customPermsList.addEventListener('click', function(e) {
    const target = e.target;
    if (!target.classList.contains('perm-checkbox')) return;

    // Ctrl toggles default behavior - native works. We'll implement Shift range selection:
    if (e.shiftKey && lastChecked) {
      const checkboxes = Array.from(document.querySelectorAll('#custom-perms-list .perm-checkbox'));
      const start = checkboxes.indexOf(lastChecked);
      const end = checkboxes.indexOf(target);
      if (start > -1 && end > -1) {
        const min = Math.min(start, end);
        const max = Math.max(start, end);
        const setChecked = lastChecked.checked; // follow the state of lastChecked
        for (let i = min; i <= max; i++) {
          checkboxes[i].checked = setChecked;
        }
      }
    }
    lastChecked = target;
  });

  // Select all / clear all
  selectAllBtn.addEventListener('click', function() {
    document.querySelectorAll('#custom-perms-list .perm-checkbox:visible, #custom-perms-list .perm-checkbox').forEach(cb => cb.checked = true);
  });
  clearAllBtn.addEventListener('click', function() {
    document.querySelectorAll('#custom-perms-list .perm-checkbox').forEach(cb => cb.checked = false);
  });

  // Save: submit the form
  saveBtn.addEventListener('click', function() {
    if (!activeUserId) { alert('Select a user first.'); return; }
    // Ensure form has user id
    formUserId.value = activeUserId;
    // Submit form
    document.getElementById('custom-perms-form').submit();
  });

  // Filter permissions by text
  permFilter.addEventListener('input', function() {
    const q = permFilter.value.trim().toLowerCase();
    document.querySelectorAll('#custom-perms-list .permission-item').forEach(item => {
      const lbl = item.querySelector('label').textContent.toLowerCase();
      if (lbl.indexOf(q) === -1) item.style.display = 'none'; else item.style.display = '';
    });
  });

  // Make JSON maps safe fallback if template provided empty
  try {
    // rolePermMap, customPermMap are already defined from template JSON decode
  } catch (err) {
    console.warn("Permission maps not available", err);
  }

}); // DOMContentLoaded
</script>

{% endblock %}
